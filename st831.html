<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能分班系统</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
        }
        
        .container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            background: #fff;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        
        h2 i {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input {
            margin-right: 10px;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-primary {
            background: #3498db;
        }
        
        .btn-success {
            background: #2ecc71;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .student-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .student-table th, .student-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        
        .student-table th {
            background-color: #f2f6fc;
            font-weight: bold;
        }
        
        .student-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .student-table tr:hover {
            background-color: #f1f7ff;
        }
        
        .animation-control {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .animation-control label {
            margin-right: 10px;
            margin-bottom: 0;
            flex: 1;
        }
        
        .animation-control input {
            flex: 2;
        }
        
        .classes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .class-box {
            flex: 1;
            min-width: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        
        .class-header {
            background: #3498db;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .student-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        
        .stats-box {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f2f6fc;
            border-radius: 8px;
            flex: 1;
            margin: 0 10px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .shuffling {
            animation: shuffle 0.5s infinite;
        }
        
        @keyframes shuffle {
            0% { transform: translateX(0); }
            25% { transform: translateX(2px); }
            50% { transform: translateX(0); }
            75% { transform: translateX(-2px); }
            100% { transform: translateX(0); }
        }
        
        .moving {
            transition: all 0.5s ease-in-out;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: white;
            border: none;
            margin-bottom: 10px;
        }
        
        .logo p {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .system-info {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 12px;
            text-align: center;
            opacity: 0.7;
        }
        
        .import-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        /* 新增样式：班级学生列表容器 */
        .class-students {
            height: 150px; /* 固定高度，大约三行 */
            overflow-y: auto; /* 滚动显示 */
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
            background: white;
        }
        
        /* 隐藏学生名单标题 */
        .main-content h1:first-child {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <h1>智能分班系统</h1>
                <p>高效、公平、可视化</p>
            </div>
            
            <div class="import-section">
                <h2>📊 数据导入</h2>
                <button class="btn btn-primary" id="importBtn">导入Excel数据</button>
                <button class="btn" id="downloadTemplate">下载模板</button>
            </div>
            
            <div class="section">
                <h2>⚙️ 分班设置</h2>
                <div class="form-group">
                    <label for="classCount">分班数量</label>
                    <input type="number" id="classCount" min="2" max="10" value="4">
                </div>
                
                <h2>📋 分班依据</h2>
                <div class="checkbox-group">
                    <input type="checkbox" id="nameBalance" checked>
                    <label for="nameBalance">姓名均衡</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="genderBalance" checked>
                    <label for="genderBalance">性别均衡</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="twinSameClass" checked>
                    <label for="twinSameClass">双胞胎同班</label>
                </div>
                
                <h2>🎚️ 动画速度</h2>
                <div class="animation-control">
                    <label for="animationSpeed">速度</label>
                    <input type="range" id="animationSpeed" min="1" max="10" value="5">
                </div>
            </div>
            
            <div class="section">
                <h2>🔄 操作</h2>
                <button class="btn btn-warning" id="shuffleBtn">开始打乱顺序</button>
                <button class="btn btn-success" id="startBtn">开始分班</button>
                <button class="btn btn-primary" id="statsBtn">查看统计</button>
                <button class="btn btn-danger" id="exportBtn">导出结果</button>
            </div>
            
            <div class="system-info">
                <p>© 2023 智能分班系统 v1.0</p>
            </div>
        </div>
        
        <div class="main-content">
            <h1>学生名单</h1>
            
            <div id="studentList">
                <table class="student-table">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>姓名</th>
                            <th>性别</th>
                            <th>身份证号</th>
                            <th>双胞胎</th>
                            <th>班级</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody">
                        <!-- 学生数据将在这里显示 -->
                    </tbody>
                </table>
            </div>
            
            <div id="classAssignment" style="display: none;">
                <h1 style="text-align: center;">XX小学分班过程</h1>
                <div id="movingStudent" style="text-align: center; padding: 20px; font-size: 18px; font-weight: bold;"></div>
                
                <div class="classes-container" id="classesContainer">
                    <!-- 班级将在这里动态生成 -->
                </div>
                
                <div id="completionMessage" style="text-align: center; padding: 20px; display: none;">
                    <h2 style="color: #2ecc71;">分班完成！</h2>
                </div>
            </div>
            
            <div id="statistics" style="display: none; margin-top: 30px;">
                <h1>分班统计</h1>
                <div class="stats-box" id="statsBox">
                    <!-- 统计信息将在这里显示 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 模拟初始数据
            const sampleData = [
                {序号: 1, 姓名: '张三', 性别: '男', 身份证号: '1101051990********001X', 双胞胎: '', 班级: ''},
                {序号: 2, 姓名: '李四', 性别: '女', 身份证号: '1101051990********002X', 双胞胎: '', 班级: ''},
                {序号: 3, 姓名: '王五', 性别: '男', 身份证号: '1101051990********003X', 双胞胎: '1', 班级: ''},
                {序号: 4, 姓名: '赵六', 性别: '女', 身份证号: '1101051990********004X', 双胞胎: '1', 班级: ''},
                {序号: 5, 姓名: '钱七', 性别: '男', 身份证号: '1101051990********005X', 双胞胎: '', 班级: ''},
                {序号: 6, 姓名: '孙八', 性别: '女', 身份证号: '1101051990********006X', 双胞胎: '', 班级: ''},
                {序号: 7, 姓名: '周九', 性别: '男', 身份证号: '1101051990********007X', 双胞胎: '2', 班级: ''},
                {序号: 8, 姓名: '吴十', 性别: '女', 身份证号: '1101051990********008X', 双胞胎: '2', 班级: ''},
                {序号: 9, 姓名: '郑十一', 性别: '男', 身份证号: '1101051990********009X', 双胞胎: '', 班级: ''},
                {序号: 10, 姓名: '王五', 性别: '男', 身份证号: '1101051990********010X', 双胞胎: '', 班级: ''}
            ];
            
            let students = [...sampleData];
            let shuffleInterval = null;
            let animationSpeed = 5;
            
            // 初始化显示学生数据
            renderStudentTable();
            
            // 下载模板
            document.getElementById('downloadTemplate').addEventListener('click', function() {
                const templateData = [
                    ['序号', '姓名', '性别', '身份证号', '双胞胎', '班级'],
                    [1, '张三', '男', '11010519900101001X', '', ''],
                    [2, '李四', '女', '11010519900202002X', '', ''],
                    [3, '王五', '男', '11010519900303003X', '1', ''],
                    [4, '赵六', '女', '11010519900404004X', '1', '']
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(templateData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '分班模板');
                
                XLSX.writeFile(wb, '分班模板.xlsx');
            });
            
            // 导入Excel
            document.getElementById('importBtn').addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx, .xls';
                
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        if (jsonData.length > 0) {
                            students = jsonData;
                            renderStudentTable();
                            alert(`成功导入 ${students.length} 条学生数据`);
                        }
                    };
                    
                    reader.readAsArrayBuffer(file);
                };
                
                input.click();
            });
            
            // 动画速度控制
            document.getElementById('animationSpeed').addEventListener('input', function() {
                animationSpeed = parseInt(this.value);
            });
            
            // 打乱顺序
            document.getElementById('shuffleBtn').addEventListener('click', function() {
                const isShuffling = this.textContent === '开始打乱顺序';
                
                if (isShuffling) {
                    this.textContent = '停止打乱顺序';
                    startShuffling();
                } else {
                    this.textContent = '开始打乱顺序';
                    stopShuffling();
                }
            });
            
            // 开始分班
            document.getElementById('startBtn').addEventListener('click', function() {
                document.getElementById('studentList').style.display = 'none';
                document.getElementById('classAssignment').style.display = 'block';
                document.getElementById('statistics').style.display = 'none';
                
                startClassAssignment();
            });
            
            // 查看统计
            document.getElementById('statsBtn').addEventListener('click', function() {
                document.getElementById('statistics').style.display = 'block';
                showStatistics();
            });
            
            // 导出结果
            document.getElementById('exportBtn').addEventListener('click', function() {
                exportResults();
            });
            
            function renderStudentTable() {
                const tbody = document.getElementById('studentTableBody');
                tbody.innerHTML = '';
                
                students.forEach(student => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${student.序号}</td>
                        <td>${student.姓名}</td>
                        <td>${student.性别}</td>
                        <td>${student.身份证号}</td>
                        <td>${student.双胞胎}</td>
                        <td>${student.班级}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
            
            function startShuffling() {
                const originalStudents = [...students];
                let counter = 0;
                
                shuffleInterval = setInterval(() => {
                    // 随机打乱学生顺序
                    for (let i = students.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [students[i], students[j]] = [students[j], students[i]];
                    }
                    
                    renderStudentTable();
                    
                    // 每打乱5次恢复一次原始顺序，避免过度打乱
                    counter++;
                    if (counter % 5 === 0) {
                        students = [...originalStudents];
                        renderStudentTable();
                    }
                }, 1000 / animationSpeed);
            }
            
            function stopShuffling() {
                if (shuffleInterval) {
                    clearInterval(shuffleInterval);
                    shuffleInterval = null;
                }
            }
            
            function startClassAssignment() {
                const classCount = parseInt(document.getElementById('classCount').value);
                const nameBalance = document.getElementById('nameBalance').checked;
                const genderBalance = document.getElementById('genderBalance').checked;
                const twinSameClass = document.getElementById('twinSameClass').checked;
                
                // 创建班级容器
                const classesContainer = document.getElementById('classesContainer');
                classesContainer.innerHTML = '';
                
                for (let i = 1; i <= classCount; i++) {
                    const classBox = document.createElement('div');
                    classBox.className = 'class-box';
                    classBox.innerHTML = `
                        <div class="class-header">${i}班</div>
                        <div id="class${i}Students" class="class-students"></div>
                    `;
                    classesContainer.appendChild(classBox);
                }
                
                // 执行分班过程
                performClassAssignment();
            }
            
            function performClassAssignment() {
                const classCount = parseInt(document.getElementById('classCount').value);
                const twinSameClass = document.getElementById('twinSameClass').checked;
                
                // 重置所有学生的班级
                students.forEach(student => {
                    student.班级 = '';
                });
                
                // 1. 处理双胞胎 - 确保同编号的双胞胎在同一班级
                if (twinSameClass) {
                    const twinGroups = {};
                    
                    // 按双胞胎编号分组
                    students.forEach(student => {
                        if (student.双胞胎 && student.双胞胎 !== '') {
                            if (!twinGroups[student.双胞胎]) {
                                twinGroups[student.双胞胎] = [];
                            }
                            twinGroups[student.双胞胎].push(student);
                        }
                    });
                    
                    // 分配双胞胎组到同一班级
                    Object.keys(twinGroups).forEach(twinId => {
                        const group = twinGroups[twinId];
                        // 随机选择一个班级
                        const targetClass = Math.floor(Math.random() * classCount) + 1;
                        
                        group.forEach(student => {
                            student.班级 = targetClass;
                        });
                    });
                }
                
                // 2. 处理剩余学生（非双胞胎和未分配的双胞胎）
                const unassignedStudents = students.filter(student => !student.班级);
                
                // 3. 处理同名学生 - 确保分配到不同班级
                const nameMap = {};
                
                unassignedStudents.forEach(student => {
                    if (!nameMap[student.姓名]) {
                        nameMap[student.姓名] = [];
                    }
                    nameMap[student.姓名].push(student);
                });
                
                // 找出有同名学生的组
                const sameNameGroups = Object.keys(nameMap).filter(name => nameMap[name].length > 1);
                
                // 分配同名学生到不同班级
                sameNameGroups.forEach(name => {
                    const group = nameMap[name];
                    const usedClasses = new Set();
                    
                    group.forEach(student => {
                        // 尝试找到一个未使用的班级
                        let targetClass = 1;
                        for (let i = 1; i <= classCount; i++) {
                            if (!usedClasses.has(i)) {
                                targetClass = i;
                                usedClasses.add(i);
                                break;
                            }
                        }
                        
                        // 如果所有班级都已使用，随机分配
                        if (usedClasses.size >= classCount) {
                            targetClass = Math.floor(Math.random() * classCount) + 1;
                        }
                        
                        student.班级 = targetClass;
                    });
                });
                
                // 4. 分配剩余学生
                const remainingStudents = unassignedStudents.filter(student => !student.班级);
                
                // 按班级人数平衡分配
                const classSizes = new Array(classCount + 1).fill(0); // 索引0不使用
                
                // 统计已分配学生
                students.forEach(student => {
                    if (student.班级) {
                        classSizes[student.班级]++;
                    }
                });
                
                // 分配剩余学生
                remainingStudents.forEach(student => {
                    // 找到人数最少的班级
                    let minSize = Infinity;
                    let targetClass = 1;
                    
                    for (let i = 1; i <= classCount; i++) {
                        if (classSizes[i] < minSize) {
                            minSize = classSizes[i];
                            targetClass = i;
                        }
                    }
                    
                    student.班级 = targetClass;
                    classSizes[targetClass]++;
                });
                
                // 5. 显示分班过程
                simulateClassAssignment();
            }
            
            function simulateClassAssignment() {
                const classCount = parseInt(document.getElementById('classCount').value);
                let currentIndex = 0;
                
                // 先清空所有班级显示
                for (let i = 1; i <= classCount; i++) {
                    document.getElementById(`class${i}Students`).innerHTML = '';
                }
                
                const assignmentInterval = setInterval(() => {
                    if (currentIndex >= students.length) {
                        clearInterval(assignmentInterval);
                        document.getElementById('completionMessage').style.display = 'block';
                        return;
                    }
                    
                    const student = students[currentIndex];
                    const targetClass = student.班级;
                    
                    // 显示移动的学生信息
                    const movingStudentDiv = document.getElementById('movingStudent');
                    movingStudentDiv.textContent = `${student.姓名} (${student.身份证号}) 正在分配到 ${targetClass}班`;
                    
                    // 添加到目标班级
                    const classDiv = document.getElementById(`class${targetClass}Students`);
                    const studentItem = document.createElement('div');
                    studentItem.className = 'student-item';
                    studentItem.textContent = `${student.姓名} (${student.性别}) ${student.双胞胎 ? '👥' + student.双胞胎 : ''}`;
                    classDiv.appendChild(studentItem);
                    
                    // 滚动到最新添加的学生
                    classDiv.scrollTop = classDiv.scrollHeight;
                    
                    currentIndex++;
                }, 1000 / animationSpeed);
            }
            
            function showStatistics() {
                const classCount = parseInt(document.getElementById('classCount').value);
                const statsBox = document.getElementById('statsBox');
                statsBox.innerHTML = '';
                
                // 计算每个班级的统计数据
                const classStats = [];
                for (let i = 1; i <= classCount; i++) {
                    classStats[i] = {
                        total: 0,
                        male: 0,
                        female: 0,
                        twins: new Set()
                    };
                }
                
                students.forEach(student => {
                    if (student.班级 && student.班级 >= 1 && student.班级 <= classCount) {
                        classStats[student.班级].total++;
                        if (student.性别 === '男') {
                            classStats[student.班级].male++;
                        } else {
                            classStats[student.班级].female++;
                        }
                        if (student.双胞胎) {
                            classStats[student.班级].twins.add(student.双胞胎);
                        }
                    }
                });
                
                for (let i = 1; i <= classCount; i++) {
                    const statItem = document.createElement('div');
                    statItem.className = 'stat-item';
                    
                    statItem.innerHTML = `
                        <h3>${i}班</h3>
                        <div class="stat-value">${classStats[i].total}</div>
                        <p>总人数</p>
                        <div class="stat-value">${classStats[i].male}</div>
                        <p>男生</p>
                        <div class="stat-value">${classStats[i].female}</div>
                        <p>女生</p>
                        <div class="stat-value">${classStats[i].twins.size}</div>
                        <p>双胞胎组数</p>
                    `;
                    
                    statsBox.appendChild(statItem);
                }
            }
            
            function exportResults() {
                // 添加班级分配信息到数据中
                const exportData = students.map(student => {
                    return {
                        ...student,
                        班级: student.班级 || '未分配'
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '分班结果');
                
                XLSX.writeFile(wb, '分班结果.xlsx');
            }
        });
    </script>
</body>
</html>